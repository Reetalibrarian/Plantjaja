<!DOCTYPE html>
<html lang="en">
  <head>
     <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="img/leaficon.ico">

    <title>Cover Template for Bootstrap</title>

    <!-- Bootstrap core CSS -->
    <link href="./dist/js/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    

    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
    <script src="./assets/js/ie-emulation-modes-warning.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link href="./dist/css/cover_ori.css" rel="stylesheet">
    <!--script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script-->
  
  </head>

  <body>

    <style>

img.plant_op {
  filter: none;
}

img.plant_op.selected {
  -webkit-filter: invert(50%);
  -moz-filter: invert(50%);
}

a.camera_blah:visited {
  text-decoration: none;
}
a:link {
  text-decoration: none;
}

a:visited {
  text-decoration: none;
}
.join('|')
a:hover {
  text-decoration: none;
}

a:active {
  text-decoration: none;
}

.loading {
  position:fixed;
  top:0px;
  background: url('spinner.gif') no-repeat center center transparent;
  width:100%;
  height:100%;
}

    </style>

    <div class="yyy ", style="position:relative;">
      <div class="dropdown" style="text-align:center ;width:auto; height:100px;margin:10px 20px;">
        <button class="  dropdown-toggle masthead-brand dropdown" type="button" id="menu1" data-toggle="dropdown"><h3 style="font-family: 'Helvetica';
        letter-spacing: 2px;font-size: 1.3em;     -webkit-margin-before: 1em;
        -webkit-margin-after: 1em;
        -webkit-margin-start: 0px;
        -webkit-margin-end: 0px;
        font-weight: bold;">Academia Sinica<br>生物多樣性研究中心</h3>
        <span class="caret"></span></button>

        <ul class="dropdown-menu" role="menu" aria-labelledby="menu1">
          <li role="presentation"><a role="menuitem" tabindex="-1" href="#">首頁</a></li>
          <li role="presentation" class="divider"></li>
          <li role="presentation"><a role="menuitem" tabindex="-1" href="#">影像偵測</a></li>
          <li role="presentation"><a role="menuitem" tabindex="-1" href="#">歷史紀錄</a></li>

        </ul>
      </div>
      <div id="yl_space">
        <p style="color:gray"> 樹葉圖像辨識開始 </p>
        <a class='camera_blah' href="#camera">
          <img class='camera_trigger' src="img/2nd_Camera2.png" alt="instruction" style="width:100px;height:100px;" etype='img'>
          <div>
            <canvas class='camera_trigger' width='0px' height='0px' id='canvas' etype='canvas'></canvas>
            <div id="submitting"></div>
          </div>
        </a>

        <input style='display:none;' type="file" name='fileToUpload' id="image_input" onchange="handleFile(this)">
        <div style='width:0px;height:0px;' id="img_preview"></div>

          <br><br><br>
          <!-- seperation line -->
          <hr class ="selection">
          <!-- 物種長相-->
          <p style="color:gray"> 請選出生長狀態</p>
          <div id="inline">  
            <div><a href="#op1">
              <img ptype="1" class="plant_op" src="img/2nd_op1.png" alt="op1_feather" style="width:50px;height:91px;"></a></div>
            <div><a  href="#op2">  
              <img ptype="2" class="plant_op" src="img/2nd_op2.png" alt="op1_three" style="width:50px;height:91px;"></a></div>
            <div><a  href="#op3">
              <img ptype="3" class="plant_op" src="img/2nd_op3.png" alt="op1_circle" style="width:91px;height:91px;"></a></div>
            <!-- <p style="color:gray"> 羽狀 &nbsp&nbsp&nbsp三出  -->
              <!-- &nbsp&nbsp輪狀 </P> -->
            <div><a  href="#op4">
              <img ptype="4" class="plant_op" src="img/2nd_op4.png" alt="op1_multi" style="width:70px;height:91px;"></a></div>
            <div><a  href="#op5">
              <img ptype="5" class="plant_op" src="img/2nd_op5.png" alt="op1_singleComplex" style="width:50px;height:91px;"></a></div>
            <p style="color:gray; padding:2px"> 羽狀 &nbsp&nbsp 三出 &nbsp&nbsp 叢生 &nbsp&nbsp 輪狀 &nbsp&nbsp 單複  </p>
            <!--next -->
          </div>
          <a href="#NextPage3">
            <img src="img/Home_btn_s.png" alt="Next Page" style="width:50px;height:50px;" align="center" onclick='submitCompressed()'></a>
      </div>

          <div class="mastfoot">
            <div class="inner">
              <!-- <p>Cover template for <a href="http://getbootstrap.com">Bootstrap</a>, by <a href="https://twitter.com/mdo">@mdo</a>.</p> -->
            </div>
          </div>

        </div>

      </div>

    </div>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="../../dist/js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../../assets/js/ie10-viewport-bug-workaround.js"></script>
    <script>

$('.camera_trigger').click(function () {
  $('#image_input').click();
});

var ptype = null;
var fileReady = false;

$('.plant_op').click(function(e){
  ptype = this.attributes['ptype'].value;
  var plant_ops = $('.plant_op');
  for (var i=0; i<plant_ops.length; i++) {
    $(plant_ops[i]).attr('class', 'plant_op');
  }
  $(this).attr('class', 'plant_op selected');
});


function submitCompressed () {
  if ((ptype === null)||(!fileReady)) {
    alert("請選取照片並選擇葉片生長狀態");
    return;
  }
  $('#submitting').attr('class', 'loading');

  // var dataURL = canvas.toDataURL('image/jpeg', 0.5); // with image quality 0.5
  var imgMimeType = 'image/jpeg';
  var dataURL = canvas.toDataURL(imgMimeType);
  var blob = dataURItoBlob(dataURL, imgMimeType);

  var fd = new FormData();
  fd.append("fileToUpload", blob);
  fd.append("phyllotaxy", ptype);
  fd.append("submit", true);

  var xhr = new XMLHttpRequest();
  xhr.open("POST", "api.php");
  xhr.onreadystatechange=function() {
    if (xhr.readyState == 4 && xhr.status == 200) {
      var data = JSON.parse(xhr.responseText);
      localStorage.im_results = data.join('|');
      // location.replace('03_result.html');
      $('image_input').files = [];
      location.href = '03_result.html';
      //var data = xhr.responseText;
    }  
  }
  xhr.send(fd);
}

function dataURItoBlob(dataURI, imgMimeType) {
  var binary = atob(dataURI.split(',')[1]);
  var array = [];
  for(var i = 0; i < binary.length; i++) {
    array.push(binary.charCodeAt(i));
  }
  return new Blob([new Uint8Array(array)], {type: imgMimeType});
}

function handleFile (t) {

  var fileToUpload = t.files[0];

  var MAX_WIDTH = 800;
  var MAX_HEIGHT = 600;

  if (fileToUpload.type.match('image/jpeg')) {
    var ip = document.getElementById('img_preview');

    var img = document.createElement("img");
    var reader = new FileReader();
    reader.onload = function(e) {
      img.src = e.target.result
      var width = img.width;
      var height = img.height;
      if (width > height) {
        if (width > MAX_WIDTH) {
          height *= MAX_WIDTH / width;
          width = MAX_WIDTH;
        }
      }
      else {
        if (height > MAX_HEIGHT) {
          width *= MAX_HEIGHT / height;
          height = MAX_HEIGHT;
        }
      }
      canvas.width = width;
      canvas.height = height;

      var ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, width, height);
    }
    reader.readAsDataURL(fileToUpload);

    // img_preview.appendChild(img);
    $('img.camera_trigger').hide();
    fileReady = true;
  }
}

    </script>
  </body>
</html>
